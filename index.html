<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íŠ¸ëŸ¼í”„ ìµœê·¼ ê¸€ & ì—…ë¹„íŠ¸ ì‹œì„¸ (10ë¶„ ìë™ ê°±ì‹ )</title>
  <style>
    :root { --max: 980px; --gap: 16px; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Apple SD Gothic Neo, 'Malgun Gothic', sans-serif; margin:0; background:#0b1220; color:#e8eefc; }
    header { max-width: var(--max); margin: 28px auto 16px; padding:0 16px; }
    h1 { font-size: 1.4rem; margin:0 0 4px; }
    .meta { color:#a9b4d0; font-size:.95rem; }
    .grid { max-width: var(--max); margin: 0 auto 40px; padding:0 16px; display:grid; gap:var(--gap); grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .card { background:#121a2b; border:1px solid #1d2740; border-radius:14px; padding:14px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
    .card h2 { font-size:1.05rem; margin:0 0 10px; color:#b8c6e8; display:flex; align-items:center; gap:8px; }
    .list { display:flex; flex-direction:column; gap:12px; }
    .item { padding:12px; border-radius:10px; background:#0f1626; border:1px solid #1a2440; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .time { color:#9fb0d9; font-size:.87rem; white-space:nowrap; }
    .text { margin:6px 0 0; line-height:1.5; color:#e8eefc; }
    .text a { color:#a9d3ff; text-decoration:underline; }
    .price-table { width:100%; border-collapse:collapse; }
    .price-table th, .price-table td { text-align:left; padding:10px 8px; border-bottom:1px solid #1a2440; }
    .price-table th { color:#a9b4d0; font-weight:600; }
    .price { font-variant-numeric: tabular-nums; }
    .chip { font-size:.8rem; padding:2px 8px; border-radius:999px; border:1px solid #31406a; color:#b8c6e8; background:#0f1729; }
    .footer { max-width: var(--max); margin: 0 auto 40px; padding:0 16px; color:#95a7d6; font-size:.9rem; }
    .warn { color:#ffdc8a; }
    .err { color:#ff9a9a; }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid #31406a; border-top-color:#a9d3ff; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <h1>íŠ¸ëŸ¼í”„ ìµœê·¼ ê¸€ & ì—…ë¹„íŠ¸ ì‹œì„¸</h1>
    <div class="meta">
      10ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹ ë¨ Â· <span id="last-updated">ë¡œë”© ì¤‘â€¦</span> Â· ì‹œê°„ëŒ€: Asia/Seoul
    </div>
  </header>

  <section class="grid">
    <article class="card">
      <h2>ğŸ•Šï¸ X(íŠ¸ìœ„í„°) @realDonaldTrump <span class="chip">ìµœê·¼ 5ê°œ</span></h2>
      <div id="x-list" class="list">
        <div class="item"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <div id="x-note" class="meta" style="margin-top:8px;"></div>
    </article>

    <article class="card">
      <h2>ğŸ—£ï¸ Truth Social @realDonaldTrump <span class="chip">ìµœê·¼ 5ê°œ</span></h2>
      <div id="truth-list" class="list">
        <div class="item"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
      <div id="truth-note" class="meta" style="margin-top:8px;"></div>
    </article>

    <article class="card">
      <h2>ğŸ’± ì—…ë¹„íŠ¸ ì‹œì„¸ (KRW) <span class="chip">BTC / ETH / XRP</span></h2>
      <table class="price-table" id="upbit-table">
        <thead>
          <tr><th>ìì‚°</th><th>ê°€ê²©(KRW)</th><th>ë³€ë™ë¥ (24h)</th><th>ê¸°ì¤€ì‹œê°</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="4"><span class="spinner"></span> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
        </tbody>
      </table>
      <div class="meta" style="margin-top:8px;">ë°ì´í„° ì œê³µ: Upbit Public API</div>
    </article>
  </section>

  <div class="footer">
    âš ï¸ <span class="warn">X(íŠ¸ìœ„í„°) APIëŠ” ì¸ì¦ í† í°ì´ í•„ìš”</span>í•©ë‹ˆë‹¤. Netlify í™˜ê²½ ë³€ìˆ˜ <code>TWITTER_BEARER_TOKEN</code> ì„¤ì • í›„ ë™ì‘í•©ë‹ˆë‹¤.
    Truth Socialì€ ê³µê°œ APIë¡œ ë™ì‘í•˜ì§€ë§Œ, ê°„í—ì  ë³€ê²½/ì†ë„ ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </div>

  <script>
    const KST = 'Asia/Seoul';
    const fmtDate = (iso) => new Intl.DateTimeFormat('ko-KR', {
      dateStyle: 'medium', timeStyle: 'short', timeZone: KST
    }).format(new Date(iso));

    const setLastUpdated = () => {
      const now = new Date();
      document.getElementById('last-updated').textContent =
        new Intl.DateTimeFormat('ko-KR', { dateStyle:'medium', timeStyle:'medium', timeZone: KST }).format(now);
    };

    // ê°„ë‹¨í•œ HTML sanitization (a, br, pë§Œ í—ˆìš©)
    function sanitizeHTML(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const allowed = ['A','BR','P'];
      const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
      const toRemove = [];
      while (walker.nextNode()) {
        const el = walker.currentNode;
        if (!allowed.includes(el.tagName)) {
          // <span> ë“±ì€ í…ìŠ¤íŠ¸ë§Œ ë‚¨ê¸°ê³  ì¹˜í™˜
          const textNode = doc.createTextNode(el.textContent || '');
          el.replaceWith(textNode);
        } else if (el.tagName === 'A') {
          // ë§í¬ëŠ” target, relë§Œ ì‚´ë¦¼
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer');
        }
      }
      return doc.body.innerHTML;
    }

    async function fetchX() {
      const list = document.getElementById('x-list');
      const note = document.getElementById('x-note');
      try {
        const res = await fetch('/.netlify/functions/x?limit=5');
        if (!res.ok) throw new Error('X API í˜¸ì¶œ ì‹¤íŒ¨: ' + res.status);
        const data = await res.json();
        const posts = data.posts || [];
        if (!posts.length) {
          list.innerHTML = '<div class="item">í‘œì‹œí•  íŠ¸ìœ—ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        list.innerHTML = posts.map(p => `
          <div class="item">
            <div class="row">
              <div class="time">${fmtDate(p.created_at)}</div>
              <a class="chip" href="${p.url}" target="_blank" rel="noopener noreferrer">ì›ë¬¸</a>
            </div>
            <div class="text">${sanitizeHTML(p.html || p.text)}</div>
          </div>
        `).join('');
        note.textContent = 'ë°ì´í„° ì¶œì²˜: X API';
      } catch (e) {
        list.innerHTML = `<div class="item err">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${e.message}</div>`;
        note.textContent = '';
      }
    }

    async function fetchTruth() {
      const list = document.getElementById('truth-list');
      const note = document.getElementById('truth-note');
      try {
        const res = await fetch('/.netlify/functions/truth?limit=5');
        if (!res.ok) throw new Error('Truth Social API í˜¸ì¶œ ì‹¤íŒ¨: ' + res.status);
        const data = await res.json();
        const posts = data.posts || [];
        if (!posts.length) {
          list.innerHTML = '<div class="item">í‘œì‹œí•  í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        list.innerHTML = posts.map(p => `
          <div class="item">
            <div class="row">
              <div class="time">${fmtDate(p.created_at)}</div>
              <a class="chip" href="${p.url}" target="_blank" rel="noopener noreferrer">ì›ë¬¸</a>
            </div>
            <div class="text">${sanitizeHTML(p.html || p.text)}</div>
          </div>
        `).join('');
        note.textContent = 'ë°ì´í„° ì¶œì²˜: Truth Social Public API';
      } catch (e) {
        list.innerHTML = `<div class="item err">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${e.message}</div>`;
        note.textContent = '';
      }
    }

    async function fetchUpbit() {
      const tbody = document.querySelector('#upbit-table tbody');
      try {
        const url = 'https://api.upbit.com/v1/ticker?markets=KRW-BTC,KRW-ETH,KRW-XRP';
        const res = await fetch(url);
        if (!res.ok) throw new Error('Upbit API í˜¸ì¶œ ì‹¤íŒ¨: ' + res.status);
        const data = await res.json();
        const rows = {
          'KRW-BTC': 'BTC',
          'KRW-ETH': 'ETH',
          'KRW-XRP': 'XRP',
        };
        // Upbit í•„ë“œ: trade_price, signed_change_rate, trade_timestamp
        const html = data
          .sort((a,b)=>a.market.localeCompare(b.market))
          .map(t => {
            const asset = rows[t.market] || t.market;
            const price = Math.round(t.trade_price).toLocaleString('ko-KR');
            const rate = (t.signed_change_rate * 100).toFixed(2);
            const ts = new Date(t.trade_timestamp); // ms
            const when = new Intl.DateTimeFormat('ko-KR',{ dateStyle:'medium', timeStyle:'short', timeZone: KST }).format(ts);
            return `<tr>
              <td>${asset}</td>
              <td class="price">${price}</td>
              <td class="price" style="color:${t.signed_change_rate>=0?'#77e0a1':'#ff9a9a'}">${rate}%</td>
              <td>${when}</td>
            </tr>`;
          }).join('');
        tbody.innerHTML = html;
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="err">ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${e.message}</td></tr>`;
      }
    }

    async function refreshAll() {
      setLastUpdated();
      await Promise.all([fetchX(), fetchTruth(), fetchUpbit()]);
    }

    // ìµœì´ˆ ë¡œë“œ + 10ë¶„(600,000ms)ë§ˆë‹¤ ê°±ì‹ 
    refreshAll();
    setInterval(refreshAll, 600000);
  </script>
</body>
</html>
